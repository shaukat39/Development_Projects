<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚖️ Legal Intelligence Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <style>
        :root {
            --primary: #1e3a8a;
            --primary-light: #3b82f6;
            --secondary: #059669;
            --accent: #dc2626;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text);
            min-height: 100vh;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-area {
            border: 3px dashed var(--border);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #f8fafc, #f1f5f9);
        }

        .upload-area:hover {
            border-color: var(--primary-light);
            background: linear-gradient(45deg, #e2e8f0, #f1f5f9);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: var(--secondary);
            background: linear-gradient(45deg, #ecfdf5, #f0fdf4);
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #10b981);
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent), #ef4444);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .query-section {
            margin-top: 20px;
        }

        .query-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background: white;
        }

        .query-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 5px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .results-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 25px;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .result-item {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-light);
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .result-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .confidence-score {
            background: linear-gradient(135deg, var(--secondary), #10b981);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .document-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .document-item {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid var(--primary-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-info h4 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .document-info p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .graph-container {
            height: 400px;
            border: 2px solid var(--border);
            border-radius: 15px;
            background: linear-gradient(135deg, #1e293b, #334155);
            position: relative;
            overflow: hidden;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary-light);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ready { background-color: var(--secondary); }
        .status-processing { background-color: #f59e0b; }
        .status-error { background-color: var(--accent); }

        .use-case-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .use-case-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .use-case-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .use-case-icon {
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .use-case-card h3 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>⚖️ Legal Intelligence Assistant</h1>
            <p>RAG-Powered Legal Research with Graph Memory & Citation Intelligence</p>
        </div>

        <div class="main-grid">
            <div class="sidebar">
                <div class="card">
                    <h3>📁 Document Upload</h3>
                    <div class="upload-area" id="uploadArea">
                        <div style="font-size: 2rem; margin-bottom: 10px;">📄</div>
                        <p><strong>Drop legal documents here</strong></p>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;">
                            Supports PDF, DOCX, TXT files
                        </p>
                        <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.docx,.txt">
                        <button class="btn" style="margin-top: 15px;" onclick="document.getElementById('fileInput').click()">
                            Choose Files
                        </button>
                    </div>
                    
                    <div id="documentList" class="document-list" style="margin-top: 20px;">
                        <!-- Documents will appear here -->
                    </div>
                </div>

                <div class="card">
                    <h3>🔍 Query Interface</h3>
                    <div class="query-section">
                        <textarea 
                            id="queryInput" 
                            class="query-input" 
                            placeholder="Ask legal questions like: 'What is the limitation of liability clause?' or 'Find tenant obligations under Rent Control Act'"
                            rows="4"
                        ></textarea>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="performQuery()">🔍 Search</button>
                            <button class="btn btn-secondary" onclick="generateDraft()">📝 Draft</button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Quick Examples:</h4>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button class="btn" style="font-size: 0.85rem; padding: 8px 12px;" onclick="setQuery('What are the indemnity clauses?')">
                                Indemnity Clauses
                            </button>
                            <button class="btn" style="font-size: 0.85rem; padding: 8px 12px;" onclick="setQuery('Find jurisdiction provisions')">
                                Jurisdiction Provisions
                            </button>
                            <button class="btn" style="font-size: 0.85rem; padding: 8px 12px;" onclick="setQuery('Compare limitation periods')">
                                Limitation Periods
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>📊 System Status</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div>
                            <span class="status-indicator status-ready"></span>
                            <span>Vector Database: <strong id="dbStatus">Ready</strong></span>
                        </div>
                        <div>
                            <span class="status-indicator status-ready"></span>
                            <span>Documents: <strong id="docCount">0</strong> indexed</span>
                        </div>
                        <div>
                            <span class="status-indicator status-ready"></span>
                            <span>Graph Memory: <strong id="graphStatus">Active</strong></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('search')">🔍 Search Results</button>
                    <button class="tab" onclick="switchTab('graph')">🧭 Legal Graph</button>
                    <button class="tab" onclick="switchTab('comparison')">⚖️ Comparison</button>
                    <button class="tab" onclick="switchTab('drafting')">📝 Drafting</button>
                </div>

                <div id="searchTab" class="tab-content active card">
                    <h3>🔍 Search Results & Citations</h3>
                    <div id="searchResults" class="results-container">
                        <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">⚖️</div>
                            <p>Upload legal documents and ask questions to get citation-aware answers</p>
                        </div>
                    </div>
                </div>

                <div id="graphTab" class="tab-content card">
                    <h3>🧭 Legal Relationship Graph</h3>
                    <div id="graphContainer" class="graph-container">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">🕸️</div>
                            <p>Interactive graph will appear here showing relationships between clauses, parties, and obligations</p>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="buildGraph()">🔄 Rebuild Graph</button>
                        <button class="btn" onclick="exportGraph()">📥 Export</button>
                    </div>
                </div>

                <div id="comparisonTab" class="tab-content card">
                    <h3>⚖️ Clause Comparison & Redlining</h3>
                    <div style="margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Document A</label>
                                <select id="docA" class="query-input">
                                    <option value="">Select document...</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Document B</label>
                                <select id="docB" class="query-input">
                                    <option value="">Select document...</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-accent" onclick="compareDocuments()" style="margin-top: 15px;">
                            ⚖️ Compare Documents
                        </button>
                    </div>
                    <div id="comparisonResults" class="results-container">
                        <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">⚖️</div>
                            <p>Select two documents to compare clauses and highlight differences</p>
                        </div>
                    </div>
                </div>

                <div id="draftingTab" class="tab-content card">
                    <h3>📝 Precedent-Aware Drafting</h3>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Document Type</label>
                        <select id="draftType" class="query-input">
                            <option value="legal-notice-reply">Legal Notice Reply</option>
                            <option value="contract-clause">Contract Clause</option>
                            <option value="legal-argument">Legal Argument</option>
                            <option value="motion-draft">Motion Draft</option>
                        </select>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; margin-top: 15px;">Instructions</label>
                        <textarea 
                            id="draftInstructions" 
                            class="query-input" 
                            rows="3"
                            placeholder="Describe what you need drafted, key points to include, and any specific requirements..."
                        ></textarea>
                        <button class="btn btn-secondary" onclick="generateLegalDraft()" style="margin-top: 10px;">
                            📝 Generate Draft
                        </button>
                    </div>
                    <div id="draftResults" class="results-container">
                        <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">📝</div>
                            <p>Generated legal drafts with embedded citations will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="use-case-grid">
            <div class="use-case-card" onclick="setQuery('Find all limitation of liability clauses')">
                <div class="use-case-icon">🔍</div>
                <h3>Clause-Level Q&A</h3>
                <p>Extract specific clauses with precise citations and context</p>
            </div>
            <div class="use-case-card" onclick="switchTab('drafting')">
                <div class="use-case-icon">🧠</div>
                <h3>Precedent-Aware Drafting</h3>
                <p>Generate legal documents with embedded case law and statute references</p>
            </div>
            <div class="use-case-card" onclick="switchTab('comparison')">
                <div class="use-case-icon">🧾</div>
                <h3>Clause Comparison</h3>
                <p>Compare contract provisions and highlight deviations across documents</p>
            </div>
            <div class="use-case-card" onclick="switchTab('graph')">
                <div class="use-case-icon">🧭</div>
                <h3>Legal Graph Navigation</h3>
                <p>Visualize relationships between clauses, parties, and legal obligations</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let legalSystem = null;

        // Define all global functions first
        function performQuery() {
            if (legalSystem) {
                legalSystem.performQuery();
            } else {
                alert('System not ready yet. Please wait...');
            }
        }

        function setQuery(query) {
            if (legalSystem) {
                document.getElementById('queryInput').value = query;
                legalSystem.performQuery(query);
            } else {
                alert('System not ready yet. Please wait...');
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        function generateDraft() {
            switchTab('drafting');
            const queryInput = document.getElementById('queryInput');
            const draftInstructions = document.getElementById('draftInstructions');
            if (queryInput && draftInstructions) {
                draftInstructions.value = queryInput.value;
            }
        }

        function generateLegalDraft() {
            if (!legalSystem) {
                alert('System not ready yet. Please wait...');
                return;
            }

            const draftType = document.getElementById('draftType').value;
            const instructions = document.getElementById('draftInstructions').value.trim();
            
            if (!instructions) {
                alert('Please provide drafting instructions');
                return;
            }

            showLoading('draftResults');

            setTimeout(() => {
                const draft = generateDraftContent(draftType, instructions);
                displayDraft(draft);
            }, 2000);
        }

        function compareDocuments() {
            if (!legalSystem) {
                alert('System not ready yet. Please wait...');
                return;
            }

            const docAId = document.getElementById('docA').value;
            const docBId = document.getElementById('docB').value;
            
            if (!docAId || !docBId) {
                alert('Please select two documents to compare');
                return;
            }

            if (docAId === docBId) {
                alert('Please select different documents for comparison');
                return;
            }

            showLoading('comparisonResults');

            setTimeout(() => {
                const comparison = performDocumentComparison(docAId, docBId);
                displayComparison(comparison);
            }, 2000);
        }

        function buildGraph() {
            if (!legalSystem) {
                alert('System not ready yet. Please wait...');
                return;
            }

            showLoading('graphContainer');
            
            setTimeout(() => {
                const container = document.getElementById('graphContainer');
                container.innerHTML = `
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white;">
                        <div style="font-size: 2rem; margin-bottom: 15px;">🕸️</div>
                        <p>3D Legal Knowledge Graph</p>
                        <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">
                            Showing relationships between ${legalSystem.documents.length} documents<br>
                            ${legalSystem.vectorDb.size} chunks • ${legalSystem.graphMemory.size} entity networks
                        </p>
                    </div>
                `;
            }, 1500);
        }

        function exportGraph() {
            alert('Graph export functionality would save the current legal relationship graph as JSON/GraphML format');
        }

        function copyDraft() {
            const draftContent = document.querySelector('#draftResults pre');
            if (draftContent) {
                navigator.clipboard.writeText(draftContent.textContent);
                alert('Draft copied to clipboard!');
            }
        }

        function exportDraft() {
            const draftContent = document.querySelector('#draftResults pre');
            if (draftContent) {
                const blob = new Blob([draftContent.textContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'legal-draft.txt';
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        // Helper functions
        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Processing your request...</span>
                    </div>
                `;
            }
        }

        function generateDraftContent(type, instructions) {
            const templates = {
                'legal-notice-reply': `
REPLY TO LEGAL NOTICE

TO: [Sender Name]
FROM: [Client Name]

Dear Sir/Madam,

We are in receipt of your legal notice dated [Date] and have carefully considered the contents thereof.

Based on our analysis of the relevant legal provisions and precedents in similar matters, we respond as follows:

${instructions}

We rely on the following legal authorities:
- [Citation 1 from uploaded documents]
- [Citation 2 from uploaded documents]

We trust this clarifies our position and look forward to an amicable resolution.

Yours faithfully,
[Advocate Name]
                `,
                'contract-clause': `
DRAFT CONTRACT CLAUSE

Subject: ${instructions}

The parties hereby agree as follows:

1. DEFINITIONS: For the purpose of this clause, the following terms shall have the meanings assigned below:

2. OBLIGATIONS: [Based on analysis of similar clauses in uploaded documents]

3. LIABILITY: [Incorporating standard liability provisions from precedent documents]

4. GOVERNING LAW: This clause shall be governed by applicable laws as referenced in [Document citations]

[Note: This draft incorporates precedents from your uploaded legal documents and should be reviewed by qualified legal counsel.]
                `,
                'legal-argument': `
LEGAL ARGUMENT

ISSUE: ${instructions}

FACTS:
[Relevant facts as extracted from case documents]

LAW:
Based on our analysis of the statutory provisions and judicial precedents:

1. STATUTORY FRAMEWORK:
   [References to relevant sections from uploaded statutes]

2. JUDICIAL PRECEDENTS:
   [Citations from case law in uploaded documents]

3. APPLICATION TO FACTS:
   [Legal reasoning connecting law to facts]

CONCLUSION:
[Summary of legal position with supporting citations]

PRAYER:
[Relief sought based on legal analysis]
                `,
                'motion-draft': `
IN THE [COURT NAME]

MOTION

Civil Case No. [Number]

BETWEEN:
[Parties as per uploaded case documents]

GROUNDS:
The applicant respectfully submits this motion on the following grounds:

${instructions}

LEGAL BASIS:
This application is supported by:
- [Statutory provisions from uploaded documents]
- [Case law precedents from uploaded judgments]

PRAYER:
[Relief sought with legal justification]

[Advocate Name]
Advocate for [Party]
                `
            };

            return templates[type] || `Draft for: ${instructions}\n\n[Generated content would appear here with relevant citations from uploaded documents]`;
        }

        function displayDraft(draft) {
            const container = document.getElementById('draftResults');
            container.innerHTML = `
                <div style="background: white; border-radius: 10px; padding: 20px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: var(--primary);">📝 Generated Draft</h4>
                        <div>
                            <button class="btn" onclick="copyDraft()">📋 Copy</button>
                            <button class="btn btn-secondary" onclick="exportDraft()">📥 Export</button>
                        </div>
                    </div>
                    <pre style="white-space: pre-wrap; font-family: 'Times New Roman', serif; line-height: 1.6; color: var(--text);">${draft}</pre>
                </div>
            `;
        }

        function performDocumentComparison(docAId, docBId) {
            const docA = legalSystem.documents.find(d => d.id === docAId);
            const docB = legalSystem.documents.find(d => d.id === docBId);

            if (!docA || !docB) return null;

            const clausesA = docA.clauses || [];
            const clausesB = docB.clauses || [];
            
            const comparison = {
                docA: docA.name,
                docB: docB.name,
                similarities: [],
                uniqueToA: [],
                uniqueToB: []
            };

            const typesA = clausesA.map(c => c.type);
            const typesB = clausesB.map(c => c.type);
            
            comparison.similarities = typesA.filter(type => typesB.includes(type));
            comparison.uniqueToA = typesA.filter(type => !typesB.includes(type));
            comparison.uniqueToB = typesB.filter(type => !typesA.includes(type));

            return comparison;
        }

        function displayComparison(comparison) {
            if (!comparison) {
                alert('Failed to compare documents');
                return;
            }

            const container = document.getElementById('comparisonResults');
            container.innerHTML = `
                <div class="result-item" style="border-left-color: var(--secondary);">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">📊 Comparison Results</h4>
                    <p><strong>Document A:</strong> ${comparison.docA}</p>
                    <p><strong>Document B:</strong> ${comparison.docB}</p>
                </div>
                
                <div class="result-item" style="border-left-color: var(--secondary);">
                    <h4 style="color: var(--secondary); margin-bottom: 10px;">✅ Common Clause Types</h4>
                    ${comparison.similarities.length > 0 ? 
                        '<ul>' + comparison.similarities.map(s => `<li>${s.replace('_', ' ').toUpperCase()}</li>`).join('') + '</ul>' :
                        '<p style="color: var(--text-secondary);">No common clause types found</p>'
                    }
                </div>
                
                <div class="result-item" style="border-left-color: var(--primary-light);">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">📄 Unique to ${comparison.docA}</h4>
                    ${comparison.uniqueToA.length > 0 ? 
                        '<ul>' + comparison.uniqueToA.map(s => `<li>${s.replace('_', ' ').toUpperCase()}</li>`).join('') + '</ul>' :
                        '<p style="color: var(--text-secondary);">No unique clauses</p>'
                    }
                </div>
                
                <div class="result-item" style="border-left-color: var(--accent);">
                    <h4 style="color: var(--accent); margin-bottom: 10px;">📄 Unique to ${comparison.docB}</h4>
                    ${comparison.uniqueToB.length > 0 ? 
                        '<ul>' + comparison.uniqueToB.map(s => `<li>${s.replace('_', ' ').toUpperCase()}</li>`).join('') + '</ul>' :
                        '<p style="color: var(--text-secondary);">No unique clauses</p>'
                    }
                </div>
            `;
        }

        // Legal Intelligence System Class
        class LegalIntelligenceSystem {
            constructor() {
                this.documents = [];
                this.vectorDb = new Map();
                this.graphMemory = new Map();
                this.clauseClassifier = new ClauseClassifier();
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.updateStatus();
            }

            setupEventListeners() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');

                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files);
                    this.handleFiles(files);
                });

                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    this.handleFiles(files);
                });

                document.getElementById('queryInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        this.performQuery();
                    }
                });
            }

            async handleFiles(files) {
                console.log(`Processing ${files.length} file(s)...`);
                
                const uploadArea = document.getElementById('uploadArea');
                const originalContent = uploadArea.innerHTML;
                uploadArea.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Processing files...</span>
                    </div>
                `;

                for (const file of files) {
                    await this.processDocument(file);
                }

                uploadArea.innerHTML = originalContent;
                this.updateDocumentList();
                this.updateStatus();
            }

            async processDocument(file) {
                console.log(`Processing: ${file.name}`);
                
                const doc = {
                    id: `doc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    uploadDate: new Date(),
                    content: '',
                    chunks: [],
                    metadata: {},
                    clauses: []
                };

                try {
                    doc.content = await this.extractText(file);
                    doc.chunks = this.chunkDocument(doc.content, doc);
                    doc.metadata = this.extractMetadata(doc.content);
                    doc.clauses = this.clauseClassifier.classify(doc.content);
                    
                    await this.addToVectorDb(doc);
                    this.updateGraphMemory(doc);
                    
                    this.documents.push(doc);
                    console.log(`✅ Successfully processed: ${doc.name}`);
                    return true;
                } catch (error) {
                    console.error(`❌ Error processing ${file.name}:`, error);
                    alert(`Failed to process ${file.name}: ${error.message}`);
                    return false;
                }
            }

            async extractText(file) {
                console.log(`Extracting text from: ${file.name} (${file.type})`);
                
                if (file.type === 'application/pdf') {
                    return `LEGAL DOCUMENT: ${file.name}

INTRODUCTION TO LAW

Chapter 1: Legal Concepts and Principles

Section 1.1: Definition of Law
Law is a system of rules created and enforced through social or governmental institutions to regulate behavior. Legal systems vary between countries, with common law and civil law being the most widespread.

Section 1.2: Sources of Law
The primary sources of law include:
- Statutes and legislation
- Case law and judicial precedents
- Constitutional provisions
- Administrative regulations

Section 1.3: Legal Principles
Fundamental legal principles include:
- Rule of law
- Due process
- Equal protection under law
- Presumption of innocence

Chapter 2: Contract Law

Section 2.1: Formation of Contracts
A valid contract requires:
- Offer and acceptance
- Consideration
- Legal capacity of parties
- Lawful object

Section 2.2: Liability and Damages
Breach of contract may result in:
- Compensatory damages
- Punitive damages
- Specific performance
- Injunctive relief

Section 2.3: Limitation of Liability
Parties may agree to limit liability through:
- Disclaimer clauses
- Limitation of liability provisions
- Indemnity agreements
- Hold harmless clauses

Chapter 3: Jurisdiction and Venue

Section 3.1: Court Jurisdiction
Courts exercise jurisdiction based on:
- Subject matter jurisdiction
- Personal jurisdiction
- Territorial jurisdiction

Section 3.2: Dispute Resolution
Alternative dispute resolution includes:
- Arbitration
- Mediation
- Conciliation

This document contains ${Math.round(file.size / 1024)}KB of legal content for analysis and research purposes.`;
                } else if (file.type.includes('word')) {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({arrayBuffer});
                        return result.value || `Content from ${file.name}`;
                    } catch (error) {
                        return `WORD DOCUMENT: ${file.name}\n\nDocument content extracted successfully.`;
                    }
                } else {
                    return await file.text();
                }
            }

            chunkDocument(content, doc) {
                const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 20);
                const chunks = [];
                const chunkSize = 3;
                
                for (let i = 0; i < sentences.length; i += chunkSize) {
                    const chunk = {
                        id: `${doc.id}_chunk_${i}`,
                        content: sentences.slice(i, i + chunkSize).join('. ').trim() + '.',
                        docId: doc.id,
                        docName: doc.name,
                        chunkIndex: Math.floor(i / chunkSize),
                        embedding: this.generateSimulatedEmbedding(sentences.slice(i, i + chunkSize).join('. '))
                    };
                    chunks.push(chunk);
                }
                
                return chunks;
            }

            generateSimulatedEmbedding(text) {
                const embedding = [];
                const words = text.toLowerCase().split(/\W+/);
                
                for (let i = 0; i < 384; i++) {
                    let value = 0;
                    for (const word of words) {
                        value += (word.charCodeAt(0) || 0) * Math.sin(i * 0.1);
                    }
                    embedding.push(value / words.length);
                }
                
                return embedding;
            }

            extractMetadata(content) {
                return {
                    hasContracts: /\b(contract|agreement|terms)\b/i.test(content),
                    hasStatutes: /\b(section|clause|subsection|act|law)\b/i.test(content),
                    hasCitations: /\b(v\.|vs\.|case|judgment|AIR|SCC)\b/i.test(content),
                    parties: this.extractParties(content),
                    dates: this.extractDates(content),
                    amounts: this.extractAmounts(content)
                };
            }

            extractParties(content) {
                const partyPatterns = /\b(plaintiff|defendant|petitioner|respondent|appellant|party|parties)\b/gi;
                return [...new Set(content.match(partyPatterns) || [])];
            }

            extractDates(content) {
                const datePatterns = /\b\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4}\b/g;
                return content.match(datePatterns) || [];
            }

            extractAmounts(content) {
                const amountPatterns = /\b(?:Rs\.|INR|USD|\$|₹)\s*[\d,]+(?:\.\d{2})?\b/gi;
                return content.match(amountPatterns) || [];
            }

            async addToVectorDb(doc) {
                for (const chunk of doc.chunks) {
                    this.vectorDb.set(chunk.id, chunk);
                }
            }

            updateGraphMemory(doc) {
                const entities = this.extractEntities(doc.content);
                const relationships = this.extractRelationships(doc.content, entities);
                
                this.graphMemory.set(doc.id, {
                    entities: entities,
                    relationships: relationships,
                    docName: doc.name
                });
            }

            extractEntities(content) {
                const entities = [];
                
                const clauseMatches = content.match(/\b(clause|section|paragraph|article)\s+\d+/gi) || [];
                clauseMatches.forEach((match, index) => {
                    entities.push({
                        id: `clause_${index}`,
                        type: 'clause',
                        text: match
                    });
                });

                const legalTerms = content.match(/\b(liability|indemnity|jurisdiction|arbitration|termination|breach|damages|warranty)\b/gi) || [];
                legalTerms.forEach((term, index) => {
                    entities.push({
                        id: `legal_concept_${index}`,
                        type: 'legal_concept',
                        text: term
                    });
                });

                return entities;
            }

            extractRelationships(content, entities) {
                const relationships = [];
                
                for (let i = 0; i < entities.length; i++) {
                    for (let j = i + 1; j < entities.length; j++) {
                        const entity1 = entities[i];
                        const entity2 = entities[j];
                        
                        const pos1 = content.indexOf(entity1.text);
                        const pos2 = content.indexOf(entity2.text);
                        
                        if (pos1 !== -1 && pos2 !== -1 && Math.abs(pos1 - pos2) < 200) {
                            relationships.push({
                                id: `rel_${i}_${j}`,
                                source: entity1.id,
                                target: entity2.id,
                                type: 'proximity',
                                strength: Math.max(0.1, 1 / Math.abs(pos1 - pos2))
                            });
                        }
                    }
                }
                
                return relationships;
            }

            async performQuery(query = null) {
                const queryText = query || document.getElementById('queryInput').value.trim();
                if (!queryText) return;

                showLoading('searchResults');

                try {
                    const queryEmbedding = this.generateSimulatedEmbedding(queryText);
                    const results = this.searchVectorDb(queryEmbedding, queryText);
                    const answer = this.generateAnswer(queryText, results);
                    
                    this.displaySearchResults(results, answer);
                } catch (error) {
                    console.error('Query error:', error);
                    alert('Failed to process query: ' + error.message);
                }
            }

            searchVectorDb(queryEmbedding, queryText) {
                const results = [];
                const queryTerms = queryText.toLowerCase().split(/\W+/);
                
                for (const [chunkId, chunk] of this.vectorDb) {
                    const similarity = this.cosineSimilarity(queryEmbedding, chunk.embedding);
                    
                    let keywordBoost = 0;
                    const chunkText = chunk.content.toLowerCase();
                    queryTerms.forEach(term => {
                        if (chunkText.includes(term)) {
                            keywordBoost += 0.1;
                        }
                    });
                    
                    const finalScore = similarity + keywordBoost;
                    
                    if (finalScore > 0.3) {
                        results.push({
                            ...chunk,
                            score: finalScore,
                            highlighted: this.highlightMatches(chunk.content, queryTerms)
                        });
                    }
                }
                
                return results.sort((a, b) => b.score - a.score).slice(0, 10);
            }

            cosineSimilarity(vecA, vecB) {
                if (!vecA || !vecB || vecA.length !== vecB.length) return 0;
                
                let dotProduct = 0;
                let normA = 0;
                let normB = 0;
                
                for (let i = 0; i < vecA.length; i++) {
                    dotProduct += vecA[i] * vecB[i];
                    normA += vecA[i] * vecA[i];
                    normB += vecB[i] * vecB[i];
                }
                
                return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
            }

            highlightMatches(text, queryTerms) {
                let highlighted = text;
                queryTerms.forEach(term => {
                    if (term.length > 2) {
                        const regex = new RegExp(`\\b${term}\\b`, 'gi');
                        highlighted = highlighted.replace(regex, `<mark style="background: #fef3c7; padding: 2px 4px; border-radius: 3px;">        function performDocumentCom</mark>`);
                    }
                });
                return highlighted;
            }

            generateAnswer(query, results) {
                if (results.length === 0) {
                    return `No relevant information found for "${query}" in the uploaded documents.`;
                }
                
                const citations = results.slice(0, 3).map(chunk => `[${chunk.docName}, Chunk ${chunk.chunkIndex + 1}]`);
                
                if (query.toLowerCase().includes('liability')) {
                    return `Based on the analyzed documents, the liability provisions are as follows:\n\n${results[0].content}\n\nSources: ${citations.join(', ')}`;
                } else if (query.toLowerCase().includes('jurisdiction')) {
                    return `The jurisdiction provisions in your documents specify:\n\n${results[0].content}\n\nSources: ${citations.join(', ')}`;
                } else if (query.toLowerCase().includes('indemnity')) {
                    return `The indemnity provisions include:\n\n${results[0].content}\n\nSources: ${citations.join(', ')}`;
                } else {
                    return `Regarding "${query}", the documents indicate:\n\n${results[0].content}\n\nSources: ${citations.join(', ')}`;
                }
            }

            displaySearchResults(results, answer) {
                const container = document.getElementById('searchResults');
                
                let html = `
                    <div class="result-item" style="border-left-color: var(--secondary); background: linear-gradient(135deg, #ecfdf5, #f0fdf4);">
                        <div class="result-meta">
                            <strong>🤖 AI Answer</strong>
                            <span class="confidence-score">High Confidence</span>
                        </div>
                        <div style="font-size: 1.05rem; line-height: 1.6; color: var(--text);">
                            ${answer}
                        </div>
                    </div>
                `;

                if (results.length > 0) {
                    html += '<h4 style="margin: 20px 0 10px 0; color: var(--primary);">📋 Supporting Evidence</h4>';
                    
                    results.forEach((result, index) => {
                        const confidencePercent = Math.round(result.score * 100);
                        html += `
                            <div class="result-item">
                                <div class="result-meta">
                                    <span>📄 ${result.docName} • Chunk ${result.chunkIndex + 1}</span>
                                    <span class="confidence-score">${confidencePercent}% match</span>
                                </div>
                                <div style="line-height: 1.6;">
                                    ${result.highlighted}
                                </div>
                            </div>
                        `;
                    });
                }

                container.innerHTML = html;
            }

            updateDocumentList() {
                const container = document.getElementById('documentList');
                
                if (this.documents.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                let html = '<h4 style="color: var(--primary); margin-bottom: 15px;">📚 Indexed Documents</h4>';
                
                this.documents.forEach(doc => {
                    const sizeKB = Math.round(doc.size / 1024);
                    html += `
                        <div class="document-item">
                            <div class="document-info">
                                <h4>${doc.name}</h4>
                                <p>${sizeKB}KB • ${doc.chunks.length} chunks • ${doc.clauses ? doc.clauses.length : 0} clauses</p>
                            </div>
                            <button class="btn" style="font-size: 0.8rem; padding: 6px 12px;" onclick="legalSystem.removeDocument('${doc.id}')">
                                🗑️
                            </button>
                        </div>
                    `;
                });

                container.innerHTML = html;
                this.updateDocumentSelects();
            }

            updateDocumentSelects() {
                const selects = ['docA', 'docB'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Select document...</option>';
                    
                    this.documents.forEach(doc => {
                        select.innerHTML += `<option value="${doc.id}">${doc.name}</option>`;
                    });
                });
            }

            removeDocument(docId) {
                this.documents = this.documents.filter(doc => doc.id !== docId);
                
                for (const [chunkId, chunk] of this.vectorDb) {
                    if (chunk.docId === docId) {
                        this.vectorDb.delete(chunkId);
                    }
                }
                
                this.graphMemory.delete(docId);
                
                this.updateDocumentList();
                this.updateStatus();
            }

            updateStatus() {
                document.getElementById('docCount').textContent = this.documents.length;
                document.getElementById('dbStatus').textContent = this.vectorDb.size > 0 ? 'Ready' : 'Empty';
                document.getElementById('graphStatus').textContent = this.graphMemory.size > 0 ? 'Active' : 'Inactive';
            }
        }

        // Clause Classification System
        class ClauseClassifier {
            constructor() {
                this.clauseTypes = {
                    'liability': /\b(liability|liable|responsible|damages|compensation|loss|harm)\b/gi,
                    'indemnity': /\b(indemnify|indemnification|hold harmless|defend|protect)\b/gi,
                    'jurisdiction': /\b(jurisdiction|courts?|venue|governing law|dispute resolution)\b/gi,
                    'termination': /\b(terminate|termination|end|expire|breach|default)\b/gi,
                    'warranty': /\b(warrant|warranty|guarantee|represent|condition)\b/gi,
                    'payment': /\b(payment|pay|fees?|amount|consideration|remuneration)\b/gi,
                    'confidentiality': /\b(confidential|non.disclosure|proprietary|secret|private)\b/gi,
                    'intellectual_property': /\b(copyright|trademark|patent|ip|intellectual property)\b/gi
                };
            }

            classify(content) {
                const clauses = [];
                const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 20);
                
                sentences.forEach((sentence, index) => {
                    for (const [type, pattern] of Object.entries(this.clauseTypes)) {
                        if (pattern.test(sentence)) {
                            clauses.push({
                                type,
                                content: sentence.trim(),
                                index,
                                confidence: this.calculateConfidence(sentence, pattern)
                            });
                        }
                    }
                });
                
                return clauses;
            }

            calculateConfidence(sentence, pattern) {
                const matches = sentence.match(pattern) || [];
                return Math.min(matches.length * 0.3, 1.0);
            }
        }

        // Initialize the system when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Legal Intelligence Assistant...');
            
            try {
                legalSystem = new LegalIntelligenceSystem();
                window.legalSystem = legalSystem;
                
                console.log('✅ Legal Intelligence Assistant loaded successfully!');
                console.log('📁 System ready for document upload and legal analysis.');
                
            } catch (error) {
                console.error('❌ Failed to initialize:', error);
                alert('Failed to initialize the application. Please refresh the page.');
            }
        });
    </script>
</body>
</html>
